<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wankel Engine Designer with Enhanced Geometry Export - (R&D Group Prop)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0d1b2a, #1b263b);
            color: #e0e1dd;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(13, 27, 42, 0.7);
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(41, 128, 185, 0.3);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
            background: linear-gradient(90deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #bdc3c7;
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(26, 36, 51, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .performance-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(26, 36, 51, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .visualization {
            flex: 100%;
            background: rgba(26, 36, 51, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(46, 204, 113, 0.3);
            margin-top: 20px;
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .input-group {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(13, 27, 42, 0.5);
            border-radius: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e0e1dd;
            font-size: 1.1rem;
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            background: #2c3e50;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.8);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2980b9;
            transform: scale(1.2);
        }
        
        .range-value {
            min-width: 60px;
            text-align: center;
            background: #3498db;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .engine-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(41, 128, 185, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(52, 152, 219, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2ecc71;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        .stat-label {
            font-size: 1rem;
            color: #bdc3c7;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            min-width: 200px;
            background: #3498db;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        #resetBtn {
            background: #e74c3c;
        }
        
        #resetBtn:hover {
            background: #c0392b;
        }
        
        #exportHousingBtn {
            background: #9b59b6;
        }
        
        #exportHousingBtn:hover {
            background: #8e44ad;
        }
        
        #exportRotorBtn {
            background: #f39c12;
        }
        
        #exportRotorBtn:hover {
            background: #d35400;
        }
        
        canvas {
            background: #0d1b2a;
            border-radius: 10px;
            width: 100%;
            height: 500px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            padding: 8px 15px;
            background: rgba(13, 27, 42, 0.6);
            border-radius: 20px;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }
        
        .epitrochoid-color {
            background: #e74c3c;
        }
        
        .rotor-color {
            background: #3498db;
        }
        
        .apex-color {
            background: #f1c40f;
        }
        
        .shaft-color {
            background: #95a5a6;
        }
        
        .info-section {
            background: rgba(26, 36, 51, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(155, 89, 182, 0.3);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-card {
            background: rgba(13, 27, 42, 0.5);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-card h3 {
            color: #9b59b6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-card ul {
            padding-left: 20px;
        }
        
        .info-card li {
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #bdc3c7;
            font-size: 0.9rem;
        }
        
        .engine-status {
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            color: #2ecc71;
        }
        
        .math-equation {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        
        .export-status {
            background: rgba(46, 204, 113, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .geometry-params {
            background: rgba(26, 36, 51, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .param-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .param-table th, .param-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .param-table th {
            background: rgba(13, 27, 42, 0.5);
            color: #3498db;
            font-weight: 600;
        }
        
        .param-table tr:hover {
            background: rgba(41, 128, 185, 0.1);
        }
        
        .param-value {
            font-family: 'Courier New', monospace;
            color: #2ecc71;
            font-weight: 500;
        }
        
        .performance-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2ecc71;
            border-bottom: 2px solid #2ecc71;
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .performance-card {
            background: rgba(13, 27, 42, 0.5);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .performance-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .performance-label {
            font-size: 1.1rem;
            color: #bdc3c7;
        }
        
        @media (max-width: 900px) {
            .content {
                flex-direction: column;
            }
            
            .visualization, .control-panel, .performance-panel {
                min-width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            button {
                min-width: 100%;
            }
            
            .performance-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-cogs"></i> Wankel Engine Geometry Designer Application</h1>
            <p class="subtitle">Version 1.3 Copyright (R&D GROUP - PROP Dte.)</p>
        </header>
        
        <div class="content">
            <div class="control-panel">
                <h2 class="panel-title"><i class="fas fa-sliders-h"></i> Engine Parameters</h2>
                
                <div class="input-group">
                    <label for="eccentricity"><i class="fas fa-arrows-alt-h"></i> Eccentricity (e) - Offset Distance (mm)</label>
                    <div class="range-container">
                        <input type="range" id="eccentricity" min="5" max="25" step="0.5" value="12">
                        <span class="range-value" id="eccValue">12 mm</span>
                    </div>
                    <div class="engine-status">Must be less than R/2</div>
                </div>
                
                <div class="input-group">
                    <label for="radius"><i class="fas fa-ruler-combined"></i> Generating Radius (R) - Rotor Size (mm)</label>
                    <div class="range-container">
                        <input type="range" id="radius" min="30" max="120" step="1" value="60">
                        <span class="range-value" id="radiusValue">60 mm</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="width"><i class="fas fa-arrows-alt-v"></i> Rotor Width (b) - Chamber Depth (mm)</label>
                    <div class="range-container">
                        <input type="range" id="width" min="30" max="100" step="1" value="50">
                        <span class="range-value" id="widthValue">50 mm</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="rpm"><i class="fas fa-tachometer-alt"></i> Engine Speed (RPM)</label>
                    <div class="range-container">
                        <input type="range" id="rpm" min="1000" max="10000" step="100" value="6000">
                        <span class="range-value" id="rpmValue">6000</span>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="animateBtn"><i class="fas fa-play"></i> Animate Engine</button>
                    <button id="resetBtn"><i class="fas fa-redo"></i> Reset Parameters</button>
                    <button id="exportHousingBtn"><i class="fas fa-download"></i> Export Housing Curve</button>
                    <button id="exportRotorBtn"><i class="fas fa-download"></i> Export Rotor Curves</button>
                </div>
                
                <div id="exportStatus" class="export-status">
                    Ready to export curves to SolidWorks
                </div>
            </div>
            
            <div class="performance-panel">
                <h2 class="performance-title"><i class="fas fa-chart-line"></i> Performance Metrics</h2>
                
                <div class="engine-stats">
                    <div class="stat-card">
                        <div class="stat-label">Displacement</div>
                        <div class="stat-value" id="displacement">0.47 L</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Compression Ratio</div>
                        <div class="stat-value" id="compression">9.2:1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Power Output</div>
                        <div class="stat-value" id="power">105 HP</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Torque</div>
                        <div class="stat-value" id="torque">122 Nm</div>
                    </div>
                </div>
                
                <div class="performance-grid">
                    <div class="performance-card">
                        <div class="performance-label">Max RPM</div>
                        <div class="performance-value">10,000</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-label">Power-to-Weight</div>
                        <div class="performance-value">1.8 HP/kg</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-label">Thermal Efficiency</div>
                        <div class="performance-value">32%</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-label">Fuel Consumption</div>
                        <div class="performance-value">8.5 L/100km</div>
                    </div>
                </div>
            </div>
            
            <div class="visualization">
                <h2 class="panel-title"><i class="fas fa-eye"></i> Engine Visualization</h2>
                <canvas id="engineCanvas" width="1100" height="500"></canvas>
                <div class="engine-status">Rotor correctly aligned with housing geometry</div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="color-box epitrochoid-color"></div>
                        <span>Housing</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box rotor-color"></div>
                        <span>Rotor</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box apex-color"></div>
                        <span>Apex Seals</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box shaft-color"></div>
                        <span>Shaft</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-section">
            <h2 class="panel-title"><i class="fas fa-info-circle"></i> Enhanced Export Features</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3><i class="fas fa-file-export"></i> Three-Arc Rotor Export</h3>
                    <p>Rotor is now exported as three separate arcs:</p>
                    <ul>
                        <li>Each arc is exported as a separate curve in SLDCRV format</li>
                        <li>Better compatibility with CAD software</li>
                        <li>Easier to manipulate individual arcs in SolidWorks</li>
                        <li>Files named: rotor_arc1, rotor_arc2, rotor_arc3</li>
                    </ul>
                </div>
                <div class="info-card">
                    <h3><i class="fas fa-calculator"></i> Geometric Parameters</h3>
                    <p>Added detailed geometric parameters:</p>
                    <ul>
                        <li>Eccentricity and generating radius</li>
                        <li>Rotor width and side length</li>
                        <li>Apex seal radius</li>
                        <li>Housing curve equations</li>
                        <li>Rotor arc specifications</li>
                    </ul>
                </div>
                <div class="info-card">
                    <h3><i class="fas fa-lightbulb"></i> Manual Creation Guide</h3>
                    <p>For manual geometry creation:</p>
                    <ul>
                        <li>Use the provided parameters table</li>
                        <li>Create housing using epitrochoid equation</li>
                        <li>Construct rotor as three arcs with specified radii</li>
                        <li>Place apex seals at calculated positions</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="geometry-params">
            <h2 class="panel-title"><i class="fas fa-ruler-combined"></i> Geometric Parameters for Manual Creation</h2>
            <table class="param-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="paramsTableBody">
                    <!-- Dynamically filled by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <footer>
            <p>Wankel Engine Designer | Enhanced Geometry Export | For Details Contact 051-9018-2212</p>
        </footer>
    </div>

    <script>
        // DOM elements
        const eccentricitySlider = document.getElementById('eccentricity');
        const radiusSlider = document.getElementById('radius');
        const widthSlider = document.getElementById('width');
        const rpmSlider = document.getElementById('rpm');
        const animateBtn = document.getElementById('animateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const exportHousingBtn = document.getElementById('exportHousingBtn');
        const exportRotorBtn = document.getElementById('exportRotorBtn');
        const exportStatus = document.getElementById('exportStatus');
        const paramsTableBody = document.getElementById('paramsTableBody');
        
        // Value displays
        const eccValue = document.getElementById('eccValue');
        const radiusValue = document.getElementById('radiusValue');
        const widthValue = document.getElementById('widthValue');
        const rpmValue = document.getElementById('rpmValue');
        
        // Engine stats
        const displacement = document.getElementById('displacement');
        const compression = document.getElementById('compression');
        const power = document.getElementById('power');
        const torque = document.getElementById('torque');
        
        // Canvas setup
        const canvas = document.getElementById('engineCanvas');
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        
        // Engine parameters with optimized limits
        let e = 12;    // Eccentricity (mm) - min:5, max:25
        let R = 60;    // Generating radius (mm) - min:30, max:120
        let b = 50;    // Rotor width (mm) - min:30, max:100
        let rpm = 6000; // Engine speed
        let angle = 0;  // Current rotation angle
        let isAnimating = false;
        let animationId = null;
        
        // Update slider value displays
        function updateSliderValues() {
            eccValue.textContent = `${e.toFixed(1)} mm`;
            radiusValue.textContent = `${R} mm`;
            widthValue.textContent = `${b} mm`;
            rpmValue.textContent = rpm;
        }
        
        // Calculate engine performance metrics
        function calculatePerformance() {
            // Displacement: V = 3 * √3 * e * R * b (in mm³)
            const displacementCC = (3 * Math.sqrt(3) * e * R * b) / 1000; // Convert to cm³ (cc)
            displacement.textContent = `${(displacementCC / 1000).toFixed(2)} L`;
            
            // Compression ratio
            const compRatio = 8.5 + (R / 40) - (e / 8);
            compression.textContent = `${compRatio.toFixed(1)}:1`;
            
            // Power output
            const powerHP = (displacementCC * rpm * 0.000008) + 30;
            power.textContent = `${Math.round(powerHP)} HP`;
            
            // Torque
            const torqueNm = (powerHP * 5252) / rpm;
            torque.textContent = `${Math.round(torqueNm)} Nm`;
        }
        
        // Draw the engine with corrected rotor geometry
        function drawEngine() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Scale for visualization
            const scale = Math.min(canvas.width, canvas.height) / (2 * (R + 2 * e)) * 0.9;
            
            // Draw epitrochoid housing
            ctx.beginPath();
            for (let i = 0; i <= 360; i++) {
                const theta = i * Math.PI / 180;
                const x = e * Math.cos(3 * theta) + R * Math.cos(theta);
                const y = e * Math.sin(3 * theta) + R * Math.sin(theta);
                
                if (i === 0) {
                    ctx.moveTo(centerX + x * scale, centerY + y * scale);
                } else {
                    ctx.lineTo(centerX + x * scale, centerY + y * scale);
                }
            }
            ctx.closePath();
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Calculate rotor center
            const rotorCenterX = e * Math.cos(angle);
            const rotorCenterY = e * Math.sin(angle);
            
            // Calculate rotor apexes using the housing curve formula
            const apexes = [];
            for (let i = 0; i < 3; i++) {
                const apexAngle = angle + i * 2 * Math.PI / 3;
                const apexX = e * Math.cos(3 * apexAngle) + R * Math.cos(apexAngle);
                const apexY = e * Math.sin(3 * apexAngle) + R * Math.sin(apexAngle);
                apexes.push({
                    x: centerX + apexX * scale,
                    y: centerY + apexY * scale
                });
            }
            
            // Draw rotor triangle
            ctx.beginPath();
            ctx.moveTo(apexes[0].x, apexes[0].y);
            ctx.lineTo(apexes[1].x, apexes[1].y);
            ctx.lineTo(apexes[2].x, apexes[2].y);
            ctx.closePath();
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = 'rgba(52, 152, 219, 0.2)';
            ctx.fill();
            
            // Draw curved rotor sides (Reuleaux triangle arcs)
            ctx.beginPath();
            for (let i = 0; i < 3; i++) {
                const startIdx = i;
                const endIdx = (i + 1) % 3;
                const centerIdx = (i + 2) % 3;
                
                const start = apexes[startIdx];
                const end = apexes[endIdx];
                const center = apexes[centerIdx];
                
                // Calculate the distance between center and start (radius of the arc)
                const dx = start.x - center.x;
                const dy = start.y - center.y;
                const radius = Math.sqrt(dx * dx + dy * dy);
                
                // Calculate start and end angles
                const startAngle = Math.atan2(start.y - center.y, start.x - center.x);
                const endAngle = Math.atan2(end.y - center.y, end.x - center.x);
                
                // Draw the arc
                ctx.arc(center.x, center.y, radius, startAngle, endAngle, false);
            }
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw apex seals
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(apexes[i].x, apexes[i].y, 6, 0, 2 * Math.PI);
                ctx.fillStyle = '#f1c40f';
                ctx.fill();
                ctx.strokeStyle = '#d35400';
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }
            
            // Draw eccentric shaft
            ctx.beginPath();
            ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI);
            ctx.fillStyle = '#95a5a6';
            ctx.fill();
            ctx.strokeStyle = '#7f8c8d';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw rotor center
            ctx.beginPath();
            ctx.arc(centerX + rotorCenterX * scale, centerY + rotorCenterY * scale, 6, 0, 2 * Math.PI);
            ctx.fillStyle = '#2ecc71';
            ctx.fill();
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 1.5;
            ctx.stroke();
            
            // Draw connecting line between centers
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + rotorCenterX * scale, centerY + rotorCenterY * scale);
            ctx.strokeStyle = 'rgba(149, 165, 166, 0.7)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw combustion chambers
            for (let i = 0; i < 3; i++) {
                const chamberAngle = angle + i * 2 * Math.PI / 3;
                const chamberX = centerX + (R * 0.7) * Math.cos(chamberAngle) * scale;
                const chamberY = centerY + (R * 0.7) * Math.sin(chamberAngle) * scale;
                
                ctx.beginPath();
                ctx.arc(chamberX, chamberY, R * 0.2 * scale, 0, 2 * Math.PI);
                
                if (i === 0) ctx.fillStyle = 'rgba(46, 204, 113, 0.3)'; // Green - intake
                else if (i === 1) {
                    ctx.fillStyle = 'rgba(231, 76, 60, 0.3)'; // Red - combustion
                    // Draw spark plug
                    ctx.beginPath();
                    ctx.arc(chamberX + 10, chamberY - 10, 4, 0, 2 * Math.PI);
                    ctx.fillStyle = '#f1c40f';
                    ctx.fill();
                }
                else ctx.fillStyle = 'rgba(155, 89, 182, 0.3)'; // Purple - exhaust
                
                ctx.fill();
            }
        }
        
        // Generate housing curve points for export
        function generateHousingCurvePoints() {
            const points = [];
            // Higher resolution for better curve quality
            for (let i = 0; i <= 360; i++) {
                const theta = i * Math.PI / 180;
                const x = e * Math.cos(3 * theta) + R * Math.cos(theta);
                const y = e * Math.sin(3 * theta) + R * Math.sin(theta);
                points.push({x, y});
            }
            return points;
        }
        
        // Generate rotor curve points as three separate arcs
        function generateRotorCurveArcs() {
            const arcs = [];
            // Calculate apexes at initial position
            const apexes = [];
            for (let i = 0; i < 3; i++) {
                const apexAngle = i * 2 * Math.PI / 3;
                const apexX = e * Math.cos(3 * apexAngle) + R * Math.cos(apexAngle);
                const apexY = e * Math.sin(3 * apexAngle) + R * Math.sin(apexAngle);
                apexes.push({x: apexX, y: apexY});
            }
            
            // Generate the three arcs of the Reuleaux triangle
            for (let i = 0; i < 3; i++) {
                const startIdx = i;
                const endIdx = (i + 1) % 3;
                const centerIdx = (i + 2) % 3;
                
                const start = apexes[startIdx];
                const end = apexes[endIdx];
                const center = apexes[centerIdx];
                
                // Calculate the distance between center and start (radius of the arc)
                const dx = start.x - center.x;
                const dy = start.y - center.y;
                const radius = Math.sqrt(dx * dx + dy * dy);
                
                // Calculate start and end angles
                const startAngle = Math.atan2(start.y - center.y, start.x - center.x);
                const endAngle = Math.atan2(end.y - center.y, end.x - center.x);
                
                // Generate points along the arc
                const steps = 60; // Points per arc
                let angleDiff = endAngle - startAngle;
                
                // Adjust angle for direction
                if (angleDiff < 0) {
                    angleDiff += 2 * Math.PI;
                }
                
                const arcPoints = [];
                for (let j = 0; j <= steps; j++) {
                    const t = j / steps;
                    const angle = startAngle + t * angleDiff;
                    const x = center.x + Math.cos(angle) * radius;
                    const y = center.y + Math.sin(angle) * radius;
                    arcPoints.push({x, y});
                }
                
                arcs.push(arcPoints);
            }
            
            return arcs;
        }
        
        // Calculate geometric parameters for display
        function calculateGeometricParams() {
            // Calculate distance between two apexes
            const apexAngle1 = 0;
            const apexX1 = e * Math.cos(3 * apexAngle1) + R * Math.cos(apexAngle1);
            const apexY1 = e * Math.sin(3 * apexAngle1) + R * Math.sin(apexAngle1);
            
            const apexAngle2 = 2 * Math.PI / 3;
            const apexX2 = e * Math.cos(3 * apexAngle2) + R * Math.cos(apexAngle2);
            const apexY2 = e * Math.sin(3 * apexAngle2) + R * Math.sin(apexAngle2);
            
            const dx = apexX1 - apexX2;
            const dy = apexY1 - apexY2;
            const sideLength = Math.sqrt(dx * dx + dy * dy);
            
            return {
                eccentricity: e,
                generatingRadius: R,
                rotorWidth: b,
                rotorSideLength: sideLength,
                apexSealRadius: sideLength, // Radius of rotor arcs
                housingCurve: `x = ${e}·cos(3θ) + ${R}·cos(θ)\ny = ${e}·sin(3θ) + ${R}·sin(θ)`,
                rotorArcRadius: sideLength.toFixed(3)
            };
        }
        
        // Update the parameters table
        function updateParamsTable() {
            const params = calculateGeometricParams();
            paramsTableBody.innerHTML = `
                <tr>
                    <td>Eccentricity (e)</td>
                    <td class="param-value">${params.eccentricity.toFixed(3)} mm</td>
                    <td>Offset distance between shaft center and rotor center</td>
                </tr>
                <tr>
                    <td>Generating Radius (R)</td>
                    <td class="param-value">${params.generatingRadius.toFixed(3)} mm</td>
                    <td>Base radius for housing curve generation</td>
                </tr>
                <tr>
                    <td>Rotor Width (b)</td>
                    <td class="param-value">${params.rotorWidth.toFixed(3)} mm</td>
                    <td>Depth of the combustion chamber</td>
                </tr>
                <tr>
                    <td>Rotor Side Length</td>
                    <td class="param-value">${params.rotorSideLength.toFixed(3)} mm</td>
                    <td>Distance between adjacent apex seals</td>
                </tr>
                <tr>
                    <td>Apex Seal Radius</td>
                    <td class="param-value">${params.apexSealRadius.toFixed(3)} mm</td>
                    <td>Radius for rotor arc curves</td>
                </tr>
                <tr>
                    <td>Housing Curve</td>
                    <td colspan="2" class="param-value">${params.housingCurve}</td>
                </tr>
            `;
        }
        
        // Export to SLDCRV file format for SolidWorks
        function exportToSLDCRV(points, filename) {
            let content = "";
            // Add header
            content += "// Exported from Wankel Engine Designer\n";
            content += "// Units: millimeters\n";
            content += "// Format: X Y Z\n\n";
            
            // Add points (Z is always 0 for 2D curves)
            points.forEach(point => {
                content += `${point.x.toFixed(6)} ${point.y.toFixed(6)} 0.000000\n`;
            });
            
            // Create a blob and download
            const blob = new Blob([content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Animation function
        function animate() {
            angle += 0.03;
            drawEngine();
            animationId = requestAnimationFrame(animate);
        }
        
        // Event listeners
        eccentricitySlider.addEventListener('input', () => {
            e = parseFloat(eccentricitySlider.value);
            // Ensure e < R/2 for proper rotor fit
            if (e >= R/2) {
                e = R/2 - 0.5;
                eccentricitySlider.value = e;
            }
            updateSliderValues();
            calculatePerformance();
            drawEngine();
            updateParamsTable();
        });
        
        radiusSlider.addEventListener('input', () => {
            R = parseInt(radiusSlider.value);
            // Ensure e < R/2
            if (e >= R/2) {
                e = R/2 - 0.5;
                eccentricitySlider.value = e;
            }
            updateSliderValues();
            calculatePerformance();
            drawEngine();
            updateParamsTable();
        });
        
        widthSlider.addEventListener('input', () => {
            b = parseInt(widthSlider.value);
            updateSliderValues();
            calculatePerformance();
            drawEngine();
            updateParamsTable();
        });
        
        rpmSlider.addEventListener('input', () => {
            rpm = parseInt(rpmSlider.value);
            updateSliderValues();
            calculatePerformance();
        });
        
        animateBtn.addEventListener('click', () => {
            if (isAnimating) {
                isAnimating = false;
                animateBtn.innerHTML = '<i class="fas fa-play"></i> Animate Engine';
                cancelAnimationFrame(animationId);
            } else {
                isAnimating = true;
                animateBtn.innerHTML = '<i class="fas fa-pause"></i> Stop Animation';
                animate();
            }
        });
        
        resetBtn.addEventListener('click', () => {
            // Reset to default values
            e = 12;
            R = 60;
            b = 50;
            rpm = 6000;
            
            eccentricitySlider.value = e;
            radiusSlider.value = R;
            widthSlider.value = b;
            rpmSlider.value = rpm;
            
            updateSliderValues();
            calculatePerformance();
            drawEngine();
            updateParamsTable();
            
            // Stop animation if running
            if (isAnimating) {
                isAnimating = false;
                animateBtn.innerHTML = '<i class="fas fa-play"></i> Animate Engine';
                cancelAnimationFrame(animationId);
            }
            
            exportStatus.textContent = "Parameters reset to default values";
        });
        
        exportHousingBtn.addEventListener('click', () => {
            const points = generateHousingCurvePoints();
            const filename = `wankel_housing_e${e.toFixed(1)}_R${R}_b${b}.sldcrv`;
            exportToSLDCRV(points, filename);
            exportStatus.innerHTML = `<i class="fas fa-check-circle"></i> Housing curve exported: ${filename}`;
        });
        
        exportRotorBtn.addEventListener('click', () => {
            const arcs = generateRotorCurveArcs();
            
            // Export each arc as a separate file
            for (let i = 0; i < arcs.length; i++) {
                const filename = `wankel_rotor_arc${i+1}_e${e.toFixed(1)}_R${R}_b${b}.sldcrv`;
                exportToSLDCRV(arcs[i], filename);
            }
            
            exportStatus.innerHTML = `<i class="fas fa-check-circle"></i> Rotor arcs exported (3 files)`;
        });
        
        // Initialize
        updateSliderValues();
        calculatePerformance();
        drawEngine();
        updateParamsTable();
    </script>
</body>
</html>